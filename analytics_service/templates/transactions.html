{% extends "base.html" %}

{% block title %}Transaction Analytics{% endblock %}
{% set page = 'transactions' %}

{% block nav_title %}üí≥ Transaction Analytics{% endblock %}

{% block content %}
<div class="container">
    <div class="section">
        <div class="section-header">
            <div>
                <div class="section-title">üí≥ Advanced Transaction Analytics</div>
                <div class="section-subtitle">Filter and analyze payment transactions by date, user, status, and more</div>
            </div>
        </div>
        
        <!-- Filters Section -->
        <div style="background: #f8f9fa; padding: 25px 30px; border-bottom: 3px solid #e9ecef;">
            <div style="font-size: 1.3em; font-weight: bold; color: #2a5298; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between;">
                <span>üîç Advanced Filters</span>
                <div style="font-size: 0.8em; font-weight: normal;">
                    Quick: 
                    <button onclick="setQuickFilter(1)" style="margin-left: 5px; padding: 4px 8px; border: none; background: #667eea; color: white; border-radius: 4px; cursor: pointer;">Today</button>
                    <button onclick="setQuickFilter(7)" style="margin-left: 5px; padding: 4px 8px; border: none; background: #667eea; color: white; border-radius: 4px; cursor: pointer;">7 Days</button>
                    <button onclick="setQuickFilter(30)" style="margin-left: 5px; padding: 4px 8px; border: none; background: #667eea; color: white; border-radius: 4px; cursor: pointer;">30 Days</button>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="font-weight: 600; color: #495057; font-size: 0.9em;">Transaction Status</label>
                    <select id="statusFilter" style="padding: 10px 12px; border: 2px solid #ced4da; border-radius: 8px; font-size: 14px;">
                        <option value="" {% if not filters.status %}selected{% endif %}>All Statuses</option>
                        <option value="success" {% if filters.status == 'success' %}selected{% endif %}>Success</option>
                        <option value="failed" {% if filters.status == 'failed' %}selected{% endif %}>Failed</option>
                    </select>
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="font-weight: 600; color: #495057; font-size: 0.9em;">User ID</label>
                    <input type="text" id="userIdFilter" placeholder="e.g., user_1234" value="{{ filters.user_id or '' }}" style="padding: 10px 12px; border: 2px solid #ced4da; border-radius: 8px; font-size: 14px;">
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="font-weight: 600; color: #495057; font-size: 0.9em;">Merchant ID</label>
                    <input type="text" id="merchantIdFilter" placeholder="e.g., merchant_567" value="{{ filters.merchant_id or '' }}" style="padding: 10px 12px; border: 2px solid #ced4da; border-radius: 8px; font-size: 14px;">
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="font-weight: 600; color: #495057; font-size: 0.9em;">Start Date</label>
                    <input type="date" id="startDateFilter" value="{{ filters.start_date or '' }}" style="padding: 10px 12px; border: 2px solid #ced4da; border-radius: 8px; font-size: 14px;">
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="font-weight: 600; color: #495057; font-size: 0.9em;">End Date</label>
                    <input type="date" id="endDateFilter" value="{{ filters.end_date or '' }}" style="padding: 10px 12px; border: 2px solid #ced4da; border-radius: 8px; font-size: 14px;">
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="font-weight: 600; color: #495057; font-size: 0.9em;">Results Limit</label>
                    <select id="limitFilter" style="padding: 10px 12px; border: 2px solid #ced4da; border-radius: 8px; font-size: 14px;">
                        <option value="25" {% if filters.limit == 25 %}selected{% endif %}>25 Results</option>
                        <option value="50" {% if filters.limit == 50 %}selected{% endif %}>50 Results</option>
                        <option value="100" {% if filters.limit == 100 %}selected{% endif %}>100 Results</option>
                        <option value="200" {% if filters.limit == 200 %}selected{% endif %}>200 Results</option>
                        <option value="500" {% if filters.limit == 500 %}selected{% endif %}>500 Results</option>
                    </select>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn" onclick="clearFilters()" style="background: #6c757d;">Clear All Filters</button>
                <button class="btn" onclick="applyFilters()">Apply Filters</button>
            </div>
        </div>
        
        <!-- Active Filters Display -->
        {% if filters.status or filters.user_id or filters.merchant_id or filters.start_date or filters.end_date %}
        <div style="background: #e3f2fd; padding: 15px 20px; margin: 20px 30px; border-radius: 8px; border-left: 4px solid #2196f3;">
            <h4 style="color: #1976d2; margin-bottom: 10px;">üéØ Active Filters:</h4>
            {% if filters.status %}
            <span style="display: inline-block; background: #2196f3; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin: 2px;">Status: {{ filters.status }}</span>
            {% endif %}
            {% if filters.user_id %}
            <span style="display: inline-block; background: #2196f3; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin: 2px;">User: {{ filters.user_id }}</span>
            {% endif %}
            {% if filters.merchant_id %}
            <span style="display: inline-block; background: #2196f3; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin: 2px;">Merchant: {{ filters.merchant_id }}</span>
            {% endif %}
            {% if filters.start_date %}
            <span style="display: inline-block; background: #2196f3; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin: 2px;">From: {{ filters.start_date }}</span>
            {% endif %}
            {% if filters.end_date %}
            <span style="display: inline-block; background: #2196f3; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin: 2px;">To: {{ filters.end_date }}</span>
            {% endif %}
            <span style="display: inline-block; background: #2196f3; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin: 2px;">Limit: {{ filters.limit }}</span>
        </div>
        {% endif %}
        
        <!-- Summary Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ '{:,}'.format(summary.total_transactions) }}</div>
                <div class="stat-label">Total in System</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ '{:,}'.format(summary.filtered_count) }}</div>
                <div class="stat-label">Filtered Results</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ summary.success_rate }}%</div>
                <div class="stat-label">Success Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${{ '{:,.0f}'.format(summary.daily_volume) }}</div>
                <div class="stat-label">Daily Volume</div>
            </div>
        </div>
        
        <!-- Transactions Table -->
        <div style="padding: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e9ecef;">
                <div style="font-size: 1.3em; font-weight: bold; color: #2a5298;">üìã Transaction Results</div>
                <div style="color: #666; font-size: 0.9em;">
                    Showing {{ transactions|length }} of {{ total_count }} filtered transactions
                    ({{ total_available }} total available)
                </div>
            </div>
            
            {% if transactions %}
            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <thead>
                    <tr>
                        <th style="background: #667eea; color: white; padding: 15px 12px; text-align: left;">Transaction ID</th>
                        <th style="background: #667eea; color: white; padding: 15px 12px; text-align: left;">Date & Time</th>
                        <th style="background: #667eea; color: white; padding: 15px 12px; text-align: left;">Amount</th>
                        <th style="background: #667eea; color: white; padding: 15px 12px; text-align: left;">Status</th>
                        <th style="background: #667eea; color: white; padding: 15px 12px; text-align: left;">User ID</th>
                        <th style="background: #667eea; color: white; padding: 15px 12px; text-align: left;">Merchant ID</th>
                        <th style="background: #667eea; color: white; padding: 15px 12px; text-align: left;">Payment Method</th>
                    </tr>
                </thead>
                <tbody>
                    {% for txn in transactions %}
                    <tr style="border-bottom: 1px solid #e9ecef;">
                        <td style="padding: 12px;">
                            <span style="font-family: monospace; font-size: 0.9em; background: #e9ecef; padding: 4px 8px; border-radius: 4px;">{{ txn.transaction_id }}</span>
                        </td>
                        <td style="padding: 12px;">{{ txn.timestamp[:19] if txn.timestamp else 'N/A' }}</td>
                        <td style="padding: 12px;"><strong>${{ '{:.2f}'.format(txn.amount) }}</strong></td>
                        <td style="padding: 12px;">
                            {% if txn.status == 'success' %}
                            <span style="color: #28a745; font-weight: bold;">‚úÖ Success</span>
                            {% else %}
                            <span style="color: #dc3545; font-weight: bold;">‚ùå Failed</span>
                            {% endif %}
                        </td>
                        <td style="padding: 12px;">
                            <a href="?user_id={{ txn.user_id }}" style="color: #667eea; text-decoration: none; font-weight: 500; padding: 2px 6px; border-radius: 4px;">{{ txn.user_id }}</a>
                        </td>
                        <td style="padding: 12px;">
                            <a href="?merchant_id={{ txn.merchant_id }}" style="color: #667eea; text-decoration: none; font-weight: 500; padding: 2px 6px; border-radius: 4px;">{{ txn.merchant_id }}</a>
                        </td>
                        <td style="padding: 12px;">
                            <span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">{{ txn.payment_method.title() }}</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div style="text-align: center; padding: 60px 20px; color: #666; font-style: italic; font-size: 1.1em;">
                <div style="font-size: 3em; margin-bottom: 20px; opacity: 0.5;">üì≠</div>
                No transactions found matching your criteria.<br>
                Try adjusting your filters or expanding the date range.
            </div>
            {% endif %}
        </div>
        
        <div style="text-align: center; padding: 20px; color: #666; font-style: italic;">
            üìÖ Last updated: {{ timestamp }} | üîÑ Auto-refresh: 2 minutes |
            üí° Click user/merchant IDs to filter by them
        </div>
    </div>
</div>

<script>
    function applyFilters() {
        const status = document.getElementById('statusFilter').value;
        const userId = document.getElementById('userIdFilter').value;
        const merchantId = document.getElementById('merchantIdFilter').value;
        const startDate = document.getElementById('startDateFilter').value;
        const endDate = document.getElementById('endDateFilter').value;
        const limit = document.getElementById('limitFilter').value;
        
        let url = '/transactions/html?limit=' + limit;
        if (status) url += '&status=' + encodeURIComponent(status);
        if (userId) url += '&user_id=' + encodeURIComponent(userId);
        if (merchantId) url += '&merchant_id=' + encodeURIComponent(merchantId);
        if (startDate) url += '&start_date=' + encodeURIComponent(startDate);
        if (endDate) url += '&end_date=' + encodeURIComponent(endDate);
        
        window.location.href = url;
    }
    
    function clearFilters() {
        window.location.href = '/transactions/html';
    }
    
    function setQuickFilter(days) {
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - days);
        
        document.getElementById('startDateFilter').value = startDate.toISOString().split('T')[0];
        document.getElementById('endDateFilter').value = endDate.toISOString().split('T')[0];
    }
    
    // Auto-refresh every 2 minutes
    setTimeout(function() { location.reload(); }, 120000);
</script>
{% endblock %}
